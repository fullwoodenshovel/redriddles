name: Build releases

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  # First job to extract version from tag
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: extract_version
        run: |
          # Remove 'v' prefix from tag (v1.0.0 â†’ 1.0.0)
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"  # Remove leading 'v'
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  # Linux build
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libxkbcommon-dev \
            libegl1-mesa-dev \
            libx11-dev \
            pkg-config

      - name: Build for Linux
        run: cargo build --release

      - name: Rename Linux binary
        run: |
          mv target/release/redriddles \
            "redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64"

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: "redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64"

  # Windows build
  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build for Windows
        run: cargo build --release

      - name: Rename Windows binary
        run: |
          Move-Item target/release/redriddles.exe `
            "redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.exe"

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: "redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.exe"

  # macOS Universal build (Intel + ARM)
  build-macos-universal:
    needs: prepare
    runs-on: macos-latest  # Use regular macOS runner (more available)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust with both macOS targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      # Build for Intel Macs
      - name: Build for macOS (Intel)
        run: cargo build --release --target x86_64-apple-darwin

      # Build for Apple Silicon Macs
      - name: Build for macOS (ARM)
        run: cargo build --release --target aarch64-apple-darwin

      # Combine both architectures into one universal binary
      - name: Create universal macOS binary
        run: |
          lipo -create \
            target/x86_64-apple-darwin/release/redriddles \
            target/aarch64-apple-darwin/release/redriddles \
            -output "redriddles-v${{ needs.prepare.outputs.version }}-macos-universal"

      - name: Upload macOS universal binary
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-binary
          path: "redriddles-v${{ needs.prepare.outputs.version }}-macos-universal"

  # Create the release with all binaries
  create-release:
    needs: [prepare, build-linux, build-windows, build-macos-universal]
    runs-on: ubuntu-latest
    steps:
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          find release-files -type f

      - name: Create release notes
        run: |
          cat > RELEASE_NOTES.md << EOF
          # Redriddles v${{ needs.prepare.outputs.version }}
          
          ## Downloads
          
          Choose the file for your operating system:
          
          ### Windows
          - **redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.exe** - For Windows 10/11 (64-bit)
          
          ### Linux
          - **redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64** - For Linux (64-bit)
            - May require: \`sudo apt install libx11-6 libegl1\` or equivalent
          
          ### macOS
          - **redriddles-v${{ needs.prepare.outputs.version }}-macos-universal** - Universal binary for ALL Macs (Intel & Apple Silicon)
          
          ## How to run
          
          ### Windows
          1. Download the .exe file
          2. Double-click to run
          
          ### Linux
          1. Download the Linux binary
          2. Make it executable: \`chmod +x redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64\`
          3. Run: \`./redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64\`
          
          ### macOS
          1. Download the universal binary
          2. You may need to right-click and select "Open" the first time (Gatekeeper)
          3. Or run from terminal: \`chmod +x redriddles-v${{ needs.prepare.outputs.version }}-macos-universal && ./redriddles-v${{ needs.prepare.outputs.version }}-macos-universal\`
          
          ## Notes
          - The macOS binary works on both Intel Macs and Apple Silicon (M1/M2/M3) Macs
          - No need to choose between different macOS versions
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release v${{ needs.prepare.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            release-files/linux-binary/redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64
            release-files/windows-binary/redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.exe
            release-files/macos-universal-binary/redriddles-v${{ needs.prepare.outputs.version }}-macos-universal