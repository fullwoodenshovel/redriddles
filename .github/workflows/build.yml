name: Build releases

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  # First job to extract version from tag
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for git log

      - name: Extract version from tag
        id: extract_version
        run: |
          # Remove 'v' prefix from tag (v1.0.0 â†’ 1.0.0)
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"  # Remove leading 'v'
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  # Linux build with ZIP
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libxkbcommon-dev \
            libegl1-mesa-dev \
            libx11-dev \
            pkg-config

      - name: Build for Linux
        run: cargo build --release

      - name: Create Linux package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Create folder structure
          mkdir -p "redriddles-v${VERSION}-linux/redriddles"
          mkdir -p "redriddles-v${VERSION}-linux/redriddles/saves"
          mkdir -p "redriddles-v${VERSION}-linux/redriddles/config"
          
          # Copy executable
          cp target/release/redriddles "redriddles-v${VERSION}-linux/redriddles/"
          
          # Create README (FIXED: use shell variable)
          cat > "redriddles-v${VERSION}-linux/redriddles/README.txt" << EOF
          Redriddles v${VERSION}

          Just extract this folder anywhere and run the executable!
          
          Your save data will be stored in the 'saves' folder.
          You can change settings in config.
          
          Folder structure:
          - redriddles          # The executable
          - saves/              # Your data
          - config/             # Settings files
          
          To run:
          1. Open terminal in this folder
          2. Make executable: chmod +x redriddles
          3. Run: ./redriddles
          
          Notes:
          - You can move this folder anywhere
          - Delete the folder to uninstall
          EOF
          
          # Make executable
          chmod +x "redriddles-v${VERSION}-linux/redriddles/redriddles"
          
          # Create ZIP
          cd "redriddles-v${VERSION}-linux"
          zip -r "../redriddles-v${VERSION}-linux-x86_64.zip" "redriddles"
          cd ..

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: "redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64.zip"

  # Windows build with ZIP
  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build for Windows
        run: cargo build --release

      - name: Create Windows package
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Create folder structure
          mkdir -p "redriddles-v${VERSION}-windows/redriddles"
          mkdir -p "redriddles-v${VERSION}-windows/redriddles/saves"
          mkdir -p "redriddles-v${VERSION}-windows/redriddles/config"
          
          # Copy executable
          cp target/release/redriddles.exe "redriddles-v${VERSION}-windows/redriddles/"
          
          # Create README
          cat > "redriddles-v${VERSION}-windows/redriddles/README.txt" << EOF
          Redriddles v${VERSION}

          Just extract this folder anywhere and run redriddles.exe!
          
          Your save data will be stored in the 'saves' folder.
          You can change settings in config.
          
          Folder structure:
          - redriddles.exe      # The executable
          - saves/              # Your data
          - config/             # Settings files
          
          To run:
          Double-click redriddles.exe
          
          Notes:
          - You can move this folder anywhere
          - Delete the folder to uninstall
          EOF

          # Install zip if not available
          if ! command -v zip &> /dev/null; then
            echo "Installing zip..."
            choco install zip -y || apt-get install -y zip || brew install zip || true
          fi
          
          # Create ZIP
          cd "redriddles-v${VERSION}-windows"
          zip -r "../redriddles-v${VERSION}-windows-x86_64.zip" "redriddles"
          cd ..

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: "redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.zip"

  # macOS Universal build with ZIP
  build-macos-universal:
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust with both macOS targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      # Build for Intel Macs
      - name: Build for macOS (Intel)
        run: cargo build --release --target x86_64-apple-darwin

      # Build for Apple Silicon Macs
      - name: Build for macOS (ARM)
        run: cargo build --release --target aarch64-apple-darwin

      # Create universal binary
      - name: Create universal macOS binary
        run: |
          lipo -create \
            target/x86_64-apple-darwin/release/redriddles \
            target/aarch64-apple-darwin/release/redriddles \
            -output "redriddles-universal"
          
          # Remove quarantine attribute
          xattr -c "redriddles-universal"

      - name: Create macOS package
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Create folder structure
          mkdir -p "redriddles-v${VERSION}-macos/redriddles"
          mkdir -p "redriddles-v${VERSION}-macos/redriddles/saves"
          mkdir -p "redriddles-v${VERSION}-macos/redriddles/config"
          
          # Copy executable
          cp "redriddles-universal" "redriddles-v${VERSION}-macos/redriddles/redriddles"
          
          # Make executable
          chmod +x "redriddles-v${VERSION}-macos/redriddles/redriddles"
          
          # Create README
          cat > "redriddles-v${VERSION}-macos/redriddles/README.txt" << EOF
          Redriddles v${VERSION}

          Just extract this folder anywhere and run the executable!
          
          Your save data will be stored in the 'saves' folder.
          You can change settings in config.
          
          Folder structure:
          - redriddles          # The executable
          - saves/              # Your data
          - config/             # Settings files
          
          To run (first time):
          1. Right-click the 'redriddles' file
          2. Select "Open"
          3. Click "Open" in the warning dialog
          
          Or from Terminal:
          1. Open terminal in this folder
          2. Run: ./redriddles
          
          Notes:
          - You can move this folder anywhere
          - Delete the folder to uninstall
          EOF
          
          # Create ZIP
          cd "redriddles-v${VERSION}-macos"
          zip -r "../redriddles-v${VERSION}-macos.zip" "redriddles"
          cd ..

      - name: Upload macOS package
        uses: actions/upload-artifact@v4
        with:
          name: macos-package
          path: "redriddles-v${{ needs.prepare.outputs.version }}-macos.zip"

  # Create the release with all binaries
  create-release:
    needs: [prepare, build-linux, build-windows, build-macos-universal]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: release-packages

      - name: Create release notes from tag
        id: release_notes
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "Using existing RELEASE_NOTES.md"
          else
            echo "No release notes found, creating default"
          VERSION="${{ needs.prepare.outputs.version }}"
          cat > RELEASE_NOTES.md << EOF
          # Redriddles v${VERSION}
          
          ## What's new
          This is stuff important for the end user, basically the technical changes, but summarised and less important changes ignored.
          These are the new features:
          
          - Bug fixes and improvements
          
          ## Technical changes
          These are all of the new commits from this release (ignoring repeats).
          This may include technical changes, architectural changes, bug fixes, etc:
          
          - Bug fixes and improvements
          
          ## Downloads
          
          ### Windows
          - **redriddles-v${VERSION}-windows-x86_64.zip**
            1. Extract the ZIP
            2. Open the 'redriddles' folder
            3. Double-click redriddles.exe
          
          ### Linux
          - **redriddles-v${VERSION}-linux-x86_64.zip**
            1. Extract the ZIP
            2. Open the 'redriddles' folder in terminal
            3. Run: \`./redriddles\`
          
          ### macOS
          - **redriddles-v${VERSION}-macos.zip**
            1. Extract the ZIP
            2. Open the 'redriddles' folder
            3. Right-click 'redriddles' and Open (first time only)
            4. Or run in terminal: \`./redriddles\`
          EOF
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release v${{ needs.prepare.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            release-packages/linux-package/redriddles-v${{ needs.prepare.outputs.version }}-linux-x86_64.zip
            release-packages/windows-package/redriddles-v${{ needs.prepare.outputs.version }}-windows-x86_64.zip
            release-packages/macos-package/redriddles-v${{ needs.prepare.outputs.version }}-macos.zip